\documentclass[acmlarge,review]{acmart}

% Essential packages
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{indentfirst}
\usepackage{cleveref}
\usepackage{stencilmacros}

% Essential declarations
\theoremstyle{definition}
\newtheorem{defn}{Definition}

\theoremstyle{plain}
\newtheorem{thm}{Theorem}
\newtheorem{lem}{Lemma}
\newtheorem{prop}{Proposition}
\newtheorem{case}{Case}

\theoremstyle{remark}
\newtheorem{remark}{Remark}

\begin{document}

\title{Lattice model}
\author{Mistral Contrastin}

\section{Giving specifications meaning}

We construct a lattice and use this lattice to give meanings to regions. We
then give full meaning to specifications by wrapping regions in variant types
for multiplicity and approximation. Model defined in this section will later be
used for two purposes. First, we show soundness of the equational theory of
specifications with respect to the model. Second, we define inference and
consistency checking procedures of specifications with respect to the
interpretations of the stencils in the code and the specifications.

\subsection{Constructing the lattice model of regions}

\begin{defn}{(\zinf)}
  We define the set \zinf{} as $\mathbb{Z}$ extended with $\infty$ and
  $-\infty$. For any $n$ in \zinf{}, we have $-\infty \leq n \leq \infty$. The
  resulting set is a total order with top and bottom elements.
\end{defn}

\begin{defn}{(\emph{Offset space})}
  \emph{Offset space} is a subset of \zinf{} members. It is used to capture
  offsets from induction variables.
\end{defn}

\begin{defn}{(\emph{\zinf{} interval})}
  A \emph{\zinf{} interval} is of the form \interv{a}{b}{c}, where $a$ and $b$
  are drawn from \zinf{} with $a \leq 0 \leq b$, $a$ is $-\infty$ \emph{iff} $b$
  is $\infty$, and $c$ is drawn from $\{ \mathsf{true}, \mathsf{false} \}$. We
  define it as follows:
%
  \begin{equation*}
    \interv{a}{b}{c} \triangleq
      \{ n \;|\; a \leq n \leq b \wedge (\neg c \implies n \neq 0) \}
  \end{equation*}

  Set of all such intervals (sets) is $\textit{Interval}$. If the superscript is
  leftout it is treated as $\mathsf{true}$.
\end{defn}

\begin{lem}{}\label{lem:zinf-identities}
  We have the following dual identities for \zinf{} intervals:
%
  \begin{align*}
    \interv{a}{b}{c} \cap \interv{d}{e}{f} & =
      \interv{\max \{a,d\}}{\min \{b,e\}}{c \wedge f} \\
    \interv{a}{b}{c} \cup \interv{d}{e}{f} & =
      \interv{\min \{a,d\}}{\max \{b,e\}}{c \vee f}
  \end{align*}
\end{lem}
%
\begin{proof}
  We give the proof of the first identity and the second one is similar.
  \begin{align*}
    \interv{a}{b}{c} \cap \interv{d}{e}{f} = &
      \; \{ n \;|\; a \leq n \leq b \wedge (\neg c \implies n \neq 0) \}
      \;\cap \\
      & \; \{ n \;|\; d \leq n \leq e \wedge (\neg f \implies n \neq 0) \}
      \\
    = & \; \{ n \;|\; \max \{a,d\} \leq n \leq \min \{b,e\} \wedge (\neg c
      \vee \neg f \implies n \neq 0) \} \\
    = & \; \interv{\max{\{a,d\}}}{\min{\{b,e\}}}{c \wedge f}
  \end{align*}
\end{proof}

\begin{defn}{(\emph{Offsets vector})}
  An $N$ dimensional \emph{offsets vector} is a Cartesian product of offset
  spaces denoted with $\textit{offs}_1 \times \cdots \times \textit{offs}_N$.
  The function $\pi_i : \zinf{}^{\mkern-19mu{N}} \to \zinf{}$ retrieves the
  $i^{th}$ set of offsets.

  The set of $N$ dimensional offsets vectors is
  $\mathcal{P}{(\zinf{}^{\mkern-19mu{N}})}$ and they trivially form a
  distributive lattice under the superset relation.
\end{defn}

\begin{defn}{(\emph{Point offsets vector})}
  A \emph{point offsets vector}, \textit{poff}, is a an offsets vector such that
  for all indices $i$ $\pi_i(\textit{poff})$, we either have a singleton set or
  the infinite interval $\interv{-\infty}{\infty}{\mathsf{true}}$.
\end{defn}

\begin{lem}{}\label{lem:vector-intersect}
  Intersection distributes over offsets vectors. If $\mathit{off}$ and
  $\mathit{off'}$ are $N$ dimensional ofssets vectors, then
%
  \begin{equation*}
    \mathit{off} \cap \mathit{off'} =
      \prod_{i = 1}^{N} \pi_i(\mathit{off}) \cap \pi_i(\mathit{off'})
  \end{equation*}
\end{lem}
%
\begin{proof}
  \begin{align*}
    \mathit{off} \; \cap \; \mathit{off'} &
    = \{x \mid \bigwedge_{1 \leq i \leq N } x_i \in \pi_i(\mathit{off}) \}
      \;\cap\;
      \{x \mid \bigwedge_{1 \leq i \leq N } x_i \in \pi_i(\mathit{off'}) \} \\
    & = \{x \mid \bigwedge_{1 \leq i \leq N }
      (x_i \in \pi_i(\mathit{off}) \wedge x_i \in \pi_i(\mathit{off'})) \} \\
    & = \prod_{i = 1}^{N} \pi_i(\mathit{off}) \cap \pi_i(\mathit{off'})
  \end{align*}
\end{proof}

\begin{lem}{}\label{lem:vector-union}
  Let $\mathit{off}$ and $\mathit{off'}$ be two $N$ dimensional offsets vectors
  such that $\pi_i(\mathit{off})$ is equal to $\pi_i(\mathit{off'})$ for all $1
  \leq i \leq N$ except possibly at $k$, then we have the following:
%
  \begin{equation*}
    \mathit{off} \; \cup \; \mathit{off'}
    =
    \pi_1(\mathit{off}) \times \cdots \times
    (\pi_k(\mathit{off}) \cup \pi_k(\mathit{off'})) \times \cdots \times
    \pi_N(\mathit{off})
  \end{equation*}
\end{lem}
%
\begin{proof}
  \begin{align*}
    \mathit{off} \; \cup \; \mathit{off'} &
    = \{x \mid
      \bigwedge_{1 \leq i \leq N } x_i \in \pi_i(\mathit{off}) \}
      \;\cup\;
      \{x \mid
          \bigwedge_{1 \leq i \leq N } x_i \in \pi_i(\mathit{off'}) \} \\
    & = \{x \mid
          \bigwedge_{\substack{1 \leq i \leq N \\ i \neq k}}
            x_i \in \pi_i(\mathit{off}) \wedge x_k \in \pi_k(\mathit{off}) \vee
          \bigwedge_{\substack{1 \leq i \leq N \\ i \neq k}} x_i \in
            \pi_i(\mathit{off'}) \wedge x_k \in \pi_k(\mathit{off'})
        \} \\
    & = \{x \mid
          \bigwedge_{\substack{1 \leq i \leq N \\ i \neq k}} x_i \in
            \pi_i(\mathit{off}) \wedge
            x_k \in \pi_k(\mathit{off}) \cup \pi_k(\mathit{off'})
        \} \\
        & = \pi_1(\mathit{off}) \times \cdots \times
        (\pi_k(\mathit{off}) \cup \pi_k(\mathit{off'})) \times \cdots \times
        \pi_N(\mathit{off})
  \end{align*}
\end{proof}

\begin{defn}{(\emph{Vector interval})}
  A vector interval is an $N$ dimensional object which has \zinf{} intervals at
  each dimension. A vector interval is also an ofssets vector.

  The set of all $N$ dimensional vector intervals is $\textit{Interval}^N$.
\end{defn}

\begin{defn}{(\emph{Region})}
  \region{N} is the set of $N$ dimensional vector intervals defined as
  the smallest set satisfying the following:
%
  \begin{enumerate}
    \item If $R$ is in $\textit{Interval}^N$, then $R$ is in \region{N}.
    \item If $R$ and $S$ are in \region{N}, then so are $R \cap S$ and
      $R \cup S$.
  \end{enumerate}
\end{defn}

\begin{prop}{}
  $(\region{N},\subseteq)$ is a distributive lattice.
\end{prop}
%
\begin{proof}
  Any sublattice of a distributive lattice is a distributive lattice. Power sets
  partially ordered with subset or equal to relation are distributive lattices.
  \region{N} is a subset of $\mathcal{P}{(\zinf{}^{\mkern-19mu{N}})}$ since all
  vector intervals are subsets of this power set and union and intersection
  cannot add an element that is not already in the powerset.  Inductive
  definition also ensures that \region{N} is closed under these operations.
  Therefore, \region{N} is a distributive sublattice of
  $(\mathcal{P}{(\zinf{}^{\mkern-19mu{N}})}, \subseteq)$.
\end{proof}

\begin{defn}{}
  $\mathsf{Mult}$ and $\mathsf{Approx}$ are parametric labelled variant types
  with injections given by their definition:
%
  \begin{align*}
    \mathsf{Mult} \; a &
      \triangleq \mathsf{mult} \; a \;\mid\; \mathsf{only} \; a \\
    \mathsf{Approx} \; a &
      \triangleq \mathsf{exact} \; a \;\mid\; \mathsf{lower} \; a \;\mid\;
        \mathsf{upper} \; a \;\mid\; \mathsf{both} \; a \; a
  \end{align*}
%
  \eg{}, $\mathsf{lower}$ is an injection $\mathsf{lower} : a \to \mathsf{Approx}
  \; a$ etc.

  These will be used in the following subsection to give meaning to the
  specification modifiers for approximation and multiplicity.
\end{defn}

\subsection{Denotational semantics for specifications}

We give some basic interpretations: $\interp{\texttt{n}} = n$ where $n$ is in
$\mathbb{Z}^+$, $\interp{\texttt{pointed}} = \llbracket \epsilon \rrbracket =
\mathsf{true}$, $\interp{\texttt{nonpointed}} = \mathsf{false}$.
Typographically, \textcap{bold monotype font} is used within specifications
to indicate a partial textual capture. For convenience, we use \textit{italic
serif font} inside specifications rather than interpreting its textual capture.
This coalesces syntactic and semantic representation but avoids clutter in the
presentation.

Let $\textit{vec-gen}_N : \mathbb{N}^+ \times \textit{Interval} \to
\textit{Interval}^N$ be the function generating an $N$ dimensional vector
interval such that \vecgen{N}{i}{\interv{a}{b}{c}} has
$\interv{-\infty}{\infty}{\mathsf{true}}$ in all dimensions except the $i^{th}$
one. There, it has \interv{a}{b}{c}.

First, we give meaning to region constants (introduced in \Cref{}).
%
\begin{align*}
  \interp{\stencil{p}{$i$}{}{}}_N & =
    \vecgen{N}{i}{\interv{0}{0}{\mathsf{true}}}\\
%
  \interp{\stencil{c}{$i$}{$k$}{\textcap{p}}}_N & =
    \vecgen{N}{i}{\interv{-k}{k}{\interp{\textcap{p}}}} \\
%
  \interp{\stencil{f}{$i$}{$k$}{\textcap{p}}}_N & =
    \vecgen{N}{i}{\interv{0}{k}{\interp{\textcap{p}}}} \\
%
  \interp{\stencil{b}{$i$}{$k$}{\textcap{p}}}_N & =
  \vecgen{N}{i}{\interv{-k}{0}{\interp{\textcap{p}}}}
\end{align*}

Second, we provide the semantics for the permissive region operator, \texttt{+},
and the restrictive region operator, \texttt{*}, by associating them with join
and meet respectively. Let \textcap{R} and \textcap{S} be regions.
%
\begin{align*}
  \interp{\texttt{\textcap{R} + \textcap{S}}}_N & =
    \interp{\textcap{R}}_N \vee \interp{\textcap{S}}_N
&
  \interp{\texttt{\textcap{R} * \textcap{S}}}_N & =
    \interp{\textcap{R}}_N \wedge \interp{\textcap{S}}_N
\end{align*}

Third, we need to mark presence of modifiers such as \texttt{readOnce} and
\texttt{atMost} as introduced in \Cref{}. In the context of
multiplicity modifiers we have the following semantics:
%
\begin{align*}
  \interp{\texttt{readOnce}} & = \mathsf{mult} &
  \llbracket\epsilon\rrbracket & = \mathsf{once}
\end{align*}

In the context of approximation modifiers, we have
%
\begin{align*}
  \interp{\texttt{atLeast}} & = \mathsf{lower} &
  \interp{\texttt{atMost}} & = \mathsf{upper} &
  \llbracket \epsilon \rrbracket = \mathsf{exact}
\end{align*}

Finally, we can give full semantics of a stencil specification:
%
\begin{equation*}
  \interp{\texttt{stencil \textcap{Mult}, \textcap{Appr}, \textcap{Region}}}_N =
    \interp{\textcap{Mult}}
           {(\interp{\textcap{Appr}}
                    {(\interp{\textcap{Region}}_N)})}
\end{equation*}

\section{Equational \& approximation theories}

We know introduce the equational and approximation theory of stencil
specifications based on $\equiv$ and $\preceq$ in the following two subsections.

\subsection{Equivalences}

We define an equivalence relation, $\equiv$, on regions as follows:

\begin{description}
  \item[Basic] \texttt{*} and \texttt{+} are both idempotent, commutative, and
    associative;
%
  \item[Subsumption] If $S$ and $R$ are regions with $S \preceq R$, then
    $S \texttt{+} R \equiv R$ and $S \texttt{*} R \equiv S$.
%
  \item[Dist] \texttt{*} distributed over \texttt{+} and dually
    \texttt{+} distributes over \texttt{*}, meaning if \textcap{R}, \textcap{S},
    and \textcap{T} are regions, then we have the following dual equivalences:
%
    \begin{align*}
      \texttt{\textcap{R}*(\textcap{S}+\textcap{T})} & \equiv
        \texttt{(\textcap{R}*\textcap{S})+(\textcap{R}*\textcap{T})} &
      \texttt{\textcap{R}+(\textcap{S}*\textcap{T})} & \equiv
        \texttt{(\textcap{R}+\textcap{S})*(\textcap{R}+\textcap{T})}
    \end{align*}
%
  \item[Overlapping pointed] If \textcap{R} is one of \texttt{forward},
    \texttt{backward}, or \texttt{centered}, then we have
%
    \begin{equation*}
      \stencil{\textcap{R}}{$n$}{$k$}{\texttt{nonpointed}} \;\texttt{+}\;
      \stencil{p}{$n$}{}{} \equiv
      \stencil{\textcap{R}}{$n$}{$k$}{}
    \end{equation*}
%
  \item[Centered] The region constants \texttt{forward} and \texttt{backward}
    are two halves of \texttt{centered} specifications:
%
    \begin{align*}
      \stencil[s]{c}{$n$}{$k$}{\textcap{p1}} \equiv
        \stencil[s]{f}{$n$}{$k$}{\textcap{p2}} \texttt{+}
        \stencil[s]{b}{$n$}{$k$}{\textcap{p3}}
    \end{align*}
%
    Here \textcap{p1} is \texttt{nonpointed} if both \textcap{p2} and
    \textcap{p3} are \texttt{nonpointed} and \texttt{pointed} otherwise.
\end{description}

\begin{thm}{(Equational soundness)}
  Equational theory is sound with respect to the lattice model. Let $R$
  and $S$ be $N$ dimensional regions, then we have
%
  \begin{equation*}
    R \equiv S \implies \interp{R}_N = \interp{S}_N
  \end{equation*}
\end{thm}

\begin{proof}
  Both $\equiv$ and $=$ are equivalence relations. We only need to show that
  each property associated with specifications equivalence holds as an equality
  in the model.
%
  \begin{description}
    \item[Basic \& Subsumption] These follow from basic properties of lattices.
%
    \item[Dist] This is immediate from the definition of distributive
      lattice which the model is one.
%
    \item[Overlapping pointed] Counterparts of individual regions for some
      Boolean $p$ are given below:
%
      \begin{align*}
        \interp{\stencil{\textcap{R}}{$n$}{$k$}{\texttt{nonpointed}}}_N
        & = \vecgen{N}{n}{\interv{-k}{k}{\mathsf{false}}} \\
%
        \interp{\stencil{p}{$n$}{}{}}_N
        &= \vecgen{N}{n}{\interv{0}{0}{\mathsf{true}}} \\
%
        \interp{\stencil{\textcap{R}}{$n$}{$k$}{}}_N
        &= \vecgen{N}{n}{\interv{-k}{k}{\mathsf{true}}}
      \end{align*}

      Using \Cref{lem:vector-union}, it is sufficient to show
      $ \interv{-k}{k}{p} \;\cup\; \interv{0}{0}{\mathsf{true}} =
        \interv{-k}{k}{\mathsf{true}} $ holds. This immediately follows from
      \Cref{lem:zinf-identities}.
%
    \item[Centered] Let $\interp{\textcap{p1}}$, $\interp{\textcap{p2}}$, and
      $\interp{\textcap{p3}}$ be $p1$, $p2$, and $p3$ respectively. We
      know that $p1$ is $p2 \vee p3$ from (\textbf{Centered}) detinition. Then
      we get the following interpretation for region constants involved in the
      equivalence:
%
      \begin{align*}
        \interp{\stencil{c}{$k$}{$n$}{$p1$}}_N
          &= \vecgen{N}{n}{\interv{-k}{k}{p2 \vee p3}} \\
%
        \interp{\stencil{f}{$k$}{$n$}{$p2$}}_N
          &= \vecgen{N}{n}{\interv{0}{k}{p2} }\\
%
        \interp{\stencil{b}{$k$}{$n$}{$p3$}}_N
          &= \vecgen{N}{n}{\interv{0}{k}{p3}}
      \end{align*}
%
      Using \Cref{lem:vector-union}, it is sufficient to show $\interv{-k}{k}{p2
      \vee p3} = \interv{0}{k}{p2} \cup \interv{-k}{0}{p3}$ holds. This
      immediately follows from \Cref{lem:zinf-identities}.
  \end{description}
\end{proof}

\subsection{Approximations}
We define a partial of order of approximations, $\preceq$. This relation
provides us with the following:

\begin{description}
  \item[Equivalence] If $S$ and $R$ are regions and $S \equiv R$, then we have
    $S \preceq R$.
%
  \item[Combined] If $S$ and $R$ are regions, then we have
    $S \preceq S \texttt{+} R$ and $S \texttt{*} R \preceq S$.
%
  \item[Depth] Let $k$ and $l$ be in positive integers and $k \leq l$, $n$ some
    fixed dimension, and \textcap{p} either \texttt{pointed} or
    \texttt{nonpointed}. Further, let \textcap{R} be one of \texttt{centered},
    \texttt{forward}, and \texttt{backward}. We then have
%
    \begin{equation*}
      \stencil{R}{$n$}{$k$}{\textcap{p}} \preceq \stencil{R}{$n$}{$l$}{\textcap{p}}
    \end{equation*}
%
\end{description}

\begin{thm}{(Approximation soundness)}
  Theory of approximation is sound with respect to the lattice model. Let $R$
  and $S$ be $N$ dimensional regions, then we have
%
  \begin{equation*}
    R \preceq S \implies \interp{R}_N \subseteq \interp{S}_N
  \end{equation*}
\end{thm}
%
\begin{proof}
  Both $\preceq$ and $\subseteq$ are partial orders on sets. We only need to
  show that each inequality holds in the model.
%
  \begin{description}
    \item[Equivalence] Region equavilance is modeled with set equality and the
      partial order on regions is modeled with subset relation. Partial orders
      are reflexive and the model of eqivalence agrees with that of the partial
      order, so this rule holds.
%
    \item[Combined] \texttt{*} and \texttt{+} maps to meet and join operations
      in the lattice. All meets and joins in a lattice satisfy these
      inequalities.

    \item[Depth] When $m$ is $k$ and $l$ in
      $\stencil{\textcap{R}}{$n$}{$m$}{\textcap{p}}$, we obtain the
      interpretations $\vecgen{N}{n}{\textit{int}_k}$ and
      $\vecgen{N}{n}{\textit{int}_l}$ for some $N$ as interpretations of
      regions. Call these \textit{ks} and \textit{ls} respectively. One way to
      show $\textit{ks} \subseteq \textit{ls}$ is to show that the intersection
      of \textit{ks} and \textit{ls} is \textit{ks}.

      To show that the intersection is \textit{ks}, we use
      \Cref{lem:vector-intersect} which reduces the problem to showing that the
      intersection of $\textit{int}_k$ and $\textit{int}_l$ is the former since
      at every point except $n$ the intervals agree, hence the intersection
      remains the same at these dimensions. Then we use
      \Cref{lem:zinf-identities} to calculate the intersection. By assumption we
      have $k \leq l$, so the maximum of the lower bounds is $-k$ and the
      minimum of lower bounds is $k$ this is same as interval $\textit{int}_k$.
      Note that pointedness is the same for both intervals and depths are
      positive integers, so the pointedness is preserved under intersection.
      This shows the intersection of \textit{ls} and \textit{ks} is indeed
      \textit{ks} and concludes the proof.
  \end{description}
\end{proof}

We present few inequalities that can be derived from the axioms and are useful
when writing specifications without inference:

\begin{prop}{(Centered approximation)}
  For any dimension $n$, depth $k$, and pointed attribute $p$,
  we have
%
  \begin{align*}
    \stencil{f}{$n$}{$k$}{\textcap{p}} & \preceq
      \stencil{c}{$n$}{$k$}{\textcap{p}} \\
%
    \stencil{b}{$n$}{$k$}{\textcap{p}} & \preceq
      \stencil{c}{$n$}{$k$}{\textcap{p}}
  \end{align*}
\end{prop}
%
\begin{proof}
  \shortv{%
    Both inequalities are proved by combining the missing half of centered by
    using the inequality (\textbf{Combined}) and then merging them into a single
    region constant using (\textbf{Centered}).
  }

  \longv{%
    Proof of the first inequality:
    \begin{align*}
      \stencil[s]{f}{$n$}{$k$}{\textcap{p}}
        & \preceq
          \stencil[s]{f}{$n$}{$k$}{\textcap{p}}
          \;\texttt{+}\;
          \stencil[s]{b}{$n$}{$k$}{\textcap{p}}
        & (\textbf{Combined}) \\
      & \equiv \stencil[s]{c}{$n$}{$k$}{\textcap{p}} & (\textbf{Centered})
    \end{align*}

    Proof of the second inequality:
    \begin{align*}
      \stencil[s]{b}{$n$}{$k$}{\textcap{p}}
        & \preceq
          \stencil[s]{f}{$n$}{$k$}{\textcap{p}}
          \;\texttt{+}\;
          \stencil[s]{b}{$n$}{$k$}{\textcap{p}}
        & (\textbf{Combined}) \\
      & \equiv \stencil[s]{c}{$n$}{$k$}{\textcap{p}} & (\textbf{Centered})
    \end{align*}
  }
\end{proof}

\begin{prop}{(Point approximation)}
  Let \textcap{R} be one of \texttt{forward}, \texttt{backward}, and
  \texttt{centered}, $n$ a fixed dimension, and $k$ a fixed depth, then we have
%
  \begin{align*}
    \stencil{p}{$n$}{}{} & \preceq \stencil{R}{$n$}{$k$}{} \\
%
    \stencil{R}{$n$}{$k$}{\texttt{nonpointed}} & \preceq
      \stencil{R}{$n$}{$k$}{}
  \end{align*}
\end{prop}
%
\begin{proof}
  \shortv{%
    Both inequalities are proved by breaking \textcap{R} using
    (\textbf{Overlapping pointed}) followed by the inequality
    (\textbf{Combined}).
  }

  \longv{%
    Proof of the first inequality:
    \begin{align*}
      \stencil[s]{p}{$n$}{}{}
        & \preceq \stencil{R}{$n$}{$k$}{nonpointed}
                  \;\texttt{+}\;
                  \stencil[s]{p}{$n$}{}{}
        & (\textbf{Combined}) \\
      & \equiv \stencil{R}{$n$}{$k$}{} & (\textbf{Overlapping pointed})
    \end{align*}

    Proof of the second inequality:
    \begin{align*}
      \stencil{R}{$n$}{$k$}{nonpointed}
        & \preceq \stencil{R}{$n$}{$k$}{nonpointed}
                  \;\texttt{+}\;
                  \stencil[s]{p}{$n$}{}{}
        & (\textbf{Combined}) \\
      & \equiv \stencil{R}{$n$}{$k$}{} & (\textbf{Overlapping pointed})
    \end{align*}
  }
\end{proof}

\section{Analysis, Consistency, Inference}

\subsection{Analysis}

\subsection{Consistency}

Once the specification is synthesised into objects in the model and stencil
under examination is analysed, consistency checking itself is remarkably simple.
Two stage checking is outlined below.

\begin{enumerate}
  \item Multiplicity of the model is checked against the stencil. The only way
    this fails is if the original specification involved \texttt{readOnce}, but
    some indexing occur multiple times in the stencil.  Note that absence of
    \texttt{readOnce} is interpreted liberally, and if the stencil indices
    happen to occur uniquely, this does not constitute a failure.
  \item Definition of vector intervals is completely unwinded into sets of
    offset tuples and depending the approximation modifier (or lack thereof)
    we compare these tuples to offsets of the stencil computation. Lower and
    upper bounds are checked with subset and superset relations respectively,
    while absence of \texttt{atMost} and \texttt{atLeast} results in exact
    checking with set equality.
\end{enumerate}

Here is the mathematical definition of consistency checking:
\begin{align*}
  \textit{consistent}(\textit{ix}, \textit{model}) & = \begin{cases}
    \mathsf{false} & \textit{model} = \mathsf{once}(x) \wedge ix = \mathsf{mult}(y) \\
    \textit{consistent'}(\textit{peel}(ix), \textit{peel}(model)) & \textit{otherwise}
  \end{cases} \\
%
  \textit{consistent'}(\textit{ix}, \textit{model}) & = \begin{cases}
    m = ix & \textit{model} = \mathsf{exact}(m) \\
    m \supseteq ix & \textit{model} = \mathsf{upper}(m) \\
    m \subseteq ix & \textit{model} = \mathsf{lower}(m)
  \end{cases}
\end{align*}

Here helper function $\textit{peel} : \mathsf{Approx} \; a \to a$ removes the
approximation label.

\todo{Here we simply show \textit{consistency'} as set equality/subset/superset,
but since sets are infinite we might need to elaborate based on representation.}

\subsection{Inference}

\begin{defn}{(Extended origin)}
  In the $N$ dimensional region space, ${(\interv{-1}{1}{})}^N$ is said to be
  the extended origin denoted $\textit{EO}_N$.
\end{defn}

\begin{defn}{(Origin distance)}
  We measure the \emph{origin distance} of a point offsets vector from the
  extended origin as the minimum number of translations by $\pm 1$ unit in one
  dimension at a time to reach any point in the extended origin. Since point
  offsets vector may represent infinite number of points, we measure the
  distance from the closest one.
\end{defn}
%
\begin{prop}{}
  The closed form of origin distance of an $N$ dimensional point offsets vector
  $p$ is the following:
%
  \begin{align*}
    \textit{dist}_i(p) & = \begin{cases}
      0 & \pi_i(p) = \interv{-\infty}{\infty}{} \\
      |\mathsf{a}| - 1 & \pi_i(p) = \{\mathsf{a}\} \\
    \end{cases} &
%
    |p| & = \sum_{i=1}^{N} dist_i(p)
  \end{align*}
\end{prop}
%
\begin{proof}
\end{proof}

\begin{defn}{(Close neighbourhood)}
  A point offsets vector $p'$ is said to be a close neighbour of point offsets
  vector $p$ if for every index $i$ except $j$, $\pi_i(p)$ agrees with
  $\pi_i(p')$ but at $j$, $\pi_j(p')$ is such that $|p'| + 1 = |p|$.

  This necessarily means point vectors within the extended origin and the
  degenerate point offsets vector with \interv{-\infty}{\infty}{} does not have
  close neighbours.
\end{defn}
%
\begin{prop}
  The unique close neighbour at index $i$ of an $N$ dimensional point offsets
  vector, if it exists, is given by the following partial function:
%
  \begin{align*}
    \mathit{close\_neighbour}(p,i) & = \prod^{N}_{j=1} \mathit{shift}(p,i,j) &
%
    \mathit{shift}(p,i,j) & =
      \begin{cases}
        \{a - 1\} & i = j \wedge \pi_i(p) = \{\mathsf{a}\} \wedge \mathsf{a} > 0\\
        \{a + 1\} & i = j \wedge \pi_i(p) = \{\mathsf{a}\} \wedge \mathsf{a} < 0\\
        \pi_j(p)  & otherwise
      \end{cases}
  \end{align*}
\end{prop}
%
\begin{proof}
\end{proof}

\begin{defn}{(Exact set)}
  The \emph{exact set} at origin distance $d$, $\mathit{ES}_{P,d}$, of a group
  of $N$ dimensional points $P$ is defined below:
%
  \begin{equation*}
    \mathit{ES}_{P,d} =
      \{ p \in P \mid \forall i.\
         p_i \notin \{-1,0,1\} \implies
         \exists p' \in \mathit{ES}_{P,d-1}.\ p' =
         \mathit{close\_neighbour}(p,i) \}
  \end{equation*}
%
  The overall \emph{exact set}, $\mathit{ES}_P$ is then
  $\bigcup_{1 \leq d \leq D} \mathit{ES}_{P,d}$, where $D$ is the maximum origin
  distance in $P$.
\end{defn}

\begin{lem}
  The following three statements are equivalent for a set of points $P \subseteq
  \mathbb{Z}^N$:
%
  \begin{enumerate}
    \item $P$ defines a superposition of hyper-rectangles each of which crosses
      the extended origin;
    \item $P$ is the same as its exact set $\mathit{ES}_P$;
    \item $P$ when regarded as offsets from induction variables forms a
      neighbourhood stencil;
    \item $P$ is a subset of \region{N}.
  \end{enumerate}
\end{lem}

\begin{thm}{(Soundness of exact shape inference)}
  For a set of point offsets vectors $P$, the inference procedure for
  neighbourhood stencils is sound if the following holds:
%
  \begin{equation*}
    \mathit{consistent}(\mathsf{mult}(P),\mathsf{mult}(\mathit{infer}(P)))
  \end{equation*}
\end{thm}

\begin{thm}{(Completeness of inference)}\label{thm:inf-completeness}
  Inference procedure can infer a specification for every stencil computation.
\end{thm}
%
\begin{proof}
  Would be nice to have.
\end{proof}

\begin{thm}{(Completeness of exact inference)}
  Inference procedure can infer a specification for every stencil computation
  with array indexing behaviour forms a superposition of hyperrectangles removed
  at most one unit from the origin in any of its dimension.
\end{thm}
%
\begin{proof}
  Would be nice to have.
\end{proof}

\begin{thm}{(Optimality of inference)}\label{thm:inf-optimality}
  For exact inference, inference procedure always infers specifications with
  fewest number of region constants.
\end{thm}
%
\begin{proof}
  Would be nice to have.
\end{proof}

\begin{remark}{}
  Optimality of general inference is trivial. We only need a single region
  constant covering accesses in any one of the stencil's dimensions and that
  would provide an upper bound for the stencil.
\end{remark}

\end{document}
